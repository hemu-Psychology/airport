<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡¯æ©æ–¯å›½å†…èˆªç«™æ¥¼èˆªç­åˆ°è¾¾çƒ­åŠ›å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Microsoft YaHei", Arial, sans-serif; margin: 20px; }
        .card { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #eee; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        button { 
            padding: 10px 20px; 
            margin: 5px 5px 5px 0; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { opacity: 0.9; }
        button:disabled { background: #cccccc; cursor: not-allowed; opacity: 1; }
        /* æƒé‡ä¿å­˜æŒ‰é’®æ ·å¼å¼ºåŒ– */
        #autoSaveBtn { background: #2196F3; }
        #saveWeightsBtn { background: #FF9800; }
        #extractOriginsBtn { background: #9C27B0; }
        #colorConfigBtn { background: #E91E63; }
        
        .heatmap-container { 
            margin-top: 30px; 
            overflow-x: auto; 
        }
        .heatmap-table { 
            border-collapse: collapse; 
            width: 100%; 
            min-width: 1200px; 
        }
        .heatmap-table th, .heatmap-table td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: center; 
        }
        .heatmap-table th { 
            background: #f2f2f2; 
            font-weight: bold; 
        }
        .heatmap-cell { 
            width: 40px; 
            height: 30px; 
            border-radius: 3px; 
            transition: all 0.3s ease; 
        }
        .heatmap-cell:hover { 
            transform: scale(1.2); 
            box-shadow: 0 0 5px rgba(0,0,0,0.2); 
        }
        .legend { 
            margin-top: 20px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex-wrap: wrap;
        }
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        .legend-color { 
            width: 20px; 
            height: 20px; 
            border-radius: 3px; 
        }
        .no-data { 
            background: #f9f9f9; 
            color: #999; 
        }
        .error { color: #ff4444; margin: 10px 0; }
        .success { color: #00C851; margin: 10px 0; }
        .info { color: #2196F3; margin: 10px 0; }
        #titleDisplay { 
            margin: 15px 0; 
            font-size: 18px; 
            font-weight: bold; 
            color: #333;
        }
        .weight-actions {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
        }
        .color-actions {
            margin: 15px 0;
            padding: 15px;
            background: #fce4ec;
            border-radius: 6px;
            border-left: 4px solid #E91E63;
        }
        .weight-input-group {
            margin: 10px 0;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .file-input-label {
            display: inline-block;
            margin: 10px 0;
            color: #666;
        }
        /* ä¿å­˜ä½ç½®æç¤ºæ ·å¼ */
        .save-path-tip {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            color: #0d47a1;
            font-size: 14px;
            border-left: 3px solid #2196F3;
        }
        /* æƒé‡è¾“å…¥æ¡†æ ·å¼å¼ºåŒ–ï¼ˆæœ€å°å€¼0ï¼‰ */
        .weight-input {
            width: 80px;
            margin-left: 10px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        .weight-input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        /* é¢œè‰²é€‰æ‹©å™¨æ ·å¼ */
        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            vertical-align: middle;
            margin: 0 10px;
        }
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: inline-block;
            margin: 0 10px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <h1>å‡¯æ©æ–¯å›½å†…èˆªç«™æ¥¼èˆªç­åˆ°è¾¾çƒ­åŠ›å›¾</h1>
    <p>è¯»å–æœ¬åœ°JSON/TXTæ–‡ä»¶ï¼Œå¯è§†åŒ–4å‘¨èˆªç­åˆ°è¾¾æ•°æ®ï¼ˆæŒ‰æ—¥Ã—å°æ—¶ç»´åº¦å±•ç¤ºåŠ æƒåˆ†å¸ƒï¼‰</p>
    
    <!-- 1. èˆªç­æ•°æ®æ–‡ä»¶åŠ è½½åŒºåŸŸ -->
    <div class="card">
        <h3>ğŸ“ æ­¥éª¤1ï¼šåŠ è½½èˆªç­æ•°æ®æ–‡ä»¶</h3>
        <input type="file" id="fileInput" accept=".txt,.json" style="margin: 10px 0;"/>
        <button id="loadFileBtn" onclick="loadLocalFile()" disabled>åŠ è½½èˆªç­æ•°æ®</button>
        <p id="fileStatus" class="error"></p>
        <div id="titleDisplay"></div> <!-- æ˜¾ç¤ºæ–‡ä»¶ä¸­çš„æ ‡é¢˜ -->
    </div>

    <!-- 2. æƒé‡é…ç½®åŒºåŸŸï¼ˆé»˜è®¤æ˜¾ç¤ºï¼Œæ›´ç›´è§‚ï¼‰ -->
    <div class="card" id="originsDiv">
        <h3>âš™ï¸ æ­¥éª¤2ï¼šé…ç½®å‡ºå‘åœ°æƒé‡ & å›¾ä¾‹é¢œè‰²</h3>
        <button id="extractOriginsBtn" onclick="extractOrigins()">ğŸ” æå–æ‰€æœ‰å‡ºå‘åœ°ï¼ˆå­—æ¯æ’åºï¼‰</button>
        
        <!-- é¢œè‰²é…ç½®åŒºåŸŸ -->
        <div class="color-actions" id="colorConfigArea">
            <h4 style="margin-top:0;">ğŸ¨ å›¾ä¾‹é¢œè‰²é…ç½®</h4>
            <div style="margin: 10px 0;">
                <label>ğŸ”˜ æœ€å°å€¼é¢œè‰²ï¼ˆæ— æ•°æ®ï¼‰ï¼š</label>
                <input type="color" id="minColorPicker" class="color-picker" value="#F5F5F5" onchange="updateColorPreview()">
                <span class="color-preview" id="minColorPreview" style="background-color: #F5F5F5;"></span>
                <span id="minColorCode">#F5F5F5</span>
            </div>
            <div style="margin: 10px 0;">
                <label>ğŸ”˜ æœ€å¤§å€¼é¢œè‰²ï¼ˆæœ€é«˜æƒé‡ï¼‰ï¼š</label>
                <input type="color" id="maxColorPicker" class="color-picker" value="#1A237E" onchange="updateColorPreview()">
                <span class="color-preview" id="maxColorPreview" style="background-color: #1A237E;"></span>
                <span id="maxColorCode">#1A237E</span>
            </div>
            <button id="colorConfigBtn" onclick="resetColorConfig()" style="margin-top:10px;">ğŸ”„ é‡ç½®é¢œè‰²é…ç½®</button>
        </div>
        
        <!-- æƒé‡ä¿å­˜/åŠ è½½åŒºåŸŸï¼ˆé»˜è®¤æ˜¾ç¤ºï¼Œä¸å†éšè—ï¼‰ -->
        <div class="weight-actions" id="weightSaveArea">
            <h4 style="margin-top:0;">ğŸ’¾ æƒé‡&é¢œè‰²é…ç½®ç®¡ç†</h4>
            <!-- ä¿å­˜ä½ç½®æç¤ºè¯´æ˜ -->
            <div class="save-path-tip">
                ğŸ“Œ <strong>ä¿å­˜ä½ç½®è¯´æ˜ï¼š</strong>æƒé‡+é¢œè‰²é…ç½®æ–‡ä»¶é»˜è®¤ä¿å­˜åˆ°æµè§ˆå™¨ã€Œä¸‹è½½ã€æ–‡ä»¶å¤¹ï¼ˆå¯åœ¨æµè§ˆå™¨è®¾ç½®ä¸­æŸ¥çœ‹/ä¿®æ”¹ä¸‹è½½è·¯å¾„ï¼‰
            </div>
            <div class="save-path-tip" style="background: #f1f8e9; color: #33691e; border-left-color: #4CAF50;">
                ğŸ“Œ <strong>é…ç½®è§„åˆ™ï¼š</strong>æƒé‡å€¼æœ€å°ä¸º0ï¼›é¢œè‰²é…ç½®ä¼šåŒæ­¥ä¿å­˜åˆ°æƒé‡æ–‡ä»¶ä¸­
            </div>
            <button id="saveWeightsBtn" onclick="saveWeightsToFile()">ğŸ“„ ä¿å­˜æƒé‡+é¢œè‰²ï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰</button>
            <button id="autoSaveBtn" onclick="autoSaveWeights()">ğŸ”„ è‡ªåŠ¨ä¿å­˜ï¼ˆè¦†ç›–ç¡®è®¤ï¼‰</button>
            
            <div style="margin: 10px 0;">
                <label class="file-input-label">ğŸ“‚ åŠ è½½å†å²æƒé‡+é¢œè‰²é…ç½®ï¼š</label>
                <input type="file" id="weightFileInput" accept=".json" onchange="loadWeightsFromFile(this)" />
            </div>
            <p id="weightStatus" class="info"></p>
        </div>

        <!-- å‡ºå‘åœ°æƒé‡è¾“å…¥æ¡†å®¹å™¨ -->
        <div id="weightInputsContainer" style="margin-top: 15px;"></div>
    </div>

    <!-- 3. ç”Ÿæˆçƒ­åŠ›å›¾åŒºåŸŸ -->
    <div class="card" id="generateArea" style="display: none;">
        <h3>ğŸ“Š æ­¥éª¤3ï¼šç”Ÿæˆçƒ­åŠ›å›¾</h3>
        <button onclick="generateHeatmap()">ğŸš€ ç”Ÿæˆèˆªç­åˆ°è¾¾çƒ­åŠ›å›¾</button>
    </div>
    
    <!-- çƒ­åŠ›å›¾è¡¨æ ¼ -->
    <div class="heatmap-container" id="heatmapContainer" style="display: none;">
        <table id="heatmapTable" class="heatmap-table"></table>
    </div>
    
    <!-- å›¾ä¾‹ -->
    <div class="legend" id="legend"></div>

    <script>
        // å…¨å±€å˜é‡
        let jsonData = [];       // èˆªç­æ•°æ®æ•°ç»„
        let fileTitle = "";      // æ–‡ä»¶ä¸­çš„æ ‡é¢˜ä¿¡æ¯
        let originWeights = {};  // å‡ºå‘åœ°æƒé‡ç¼“å­˜ï¼ˆç”¨äºä¿å­˜/åŠ è½½ï¼‰
        let lastWeightFile = ""; // è®°å½•æœ€åä¿å­˜/åŠ è½½çš„æƒé‡æ–‡ä»¶å
        let allOrigins = [];     // å­˜å‚¨æ‰€æœ‰æå–çš„å‡ºå‘åœ°ï¼ˆç”¨äºè¯»å–æƒé‡æ—¶åŒæ­¥ï¼‰
        // é¢œè‰²é…ç½®å…¨å±€å˜é‡
        let colorConfig = {
            minColor: "#F5F5F5", // æœ€å°å€¼é¢œè‰²ï¼ˆæ— æ•°æ®ï¼‰
            maxColor: "#1A237E"  // æœ€å¤§å€¼é¢œè‰²ï¼ˆæœ€é«˜æƒé‡ï¼‰
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            document.getElementById('weightSaveArea').style.display = 'block';
            document.getElementById('colorConfigArea').style.display = 'block';
            // åˆå§‹åŒ–é¢œè‰²é¢„è§ˆ
            updateColorPreview();
            // åˆå§‹çŠ¶æ€ä¸‹ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼ˆæç¤ºéœ€è¦å…ˆæå–å‡ºå‘åœ°ï¼‰
            document.getElementById('saveWeightsBtn').disabled = true;
            document.getElementById('autoSaveBtn').disabled = true;
            document.getElementById('weightStatus').textContent = "ğŸ’¡ æç¤ºï¼šè¯·å…ˆåŠ è½½èˆªç­æ•°æ®å¹¶æå–å‡ºå‘åœ°ï¼Œæƒé‡+é¢œè‰²é…ç½®æ–‡ä»¶å°†ä¿å­˜åˆ°æµè§ˆå™¨é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹ï¼Œæƒé‡å€¼æœ€å°ä¸º0";
            document.getElementById('weightStatus').className = "info";
        };

        // æ›´æ–°é¢œè‰²é¢„è§ˆå’Œä»£ç æ˜¾ç¤º
        function updateColorPreview() {
            const minColor = document.getElementById('minColorPicker').value;
            const maxColor = document.getElementById('maxColorPicker').value;
            
            // æ›´æ–°é¢„è§ˆå’Œä»£ç 
            document.getElementById('minColorPreview').style.backgroundColor = minColor;
            document.getElementById('minColorCode').textContent = minColor;
            document.getElementById('maxColorPreview').style.backgroundColor = maxColor;
            document.getElementById('maxColorCode').textContent = maxColor;
            
            // æ›´æ–°å…¨å±€é¢œè‰²é…ç½®
            colorConfig.minColor = minColor;
            colorConfig.maxColor = maxColor;
        }

        // é‡ç½®é¢œè‰²é…ç½®ä¸ºé»˜è®¤å€¼
        function resetColorConfig() {
            colorConfig = {
                minColor: "#F5F5F5",
                maxColor: "#1A237E"
            };
            // æ›´æ–°é€‰æ‹©å™¨å’Œé¢„è§ˆ
            document.getElementById('minColorPicker').value = colorConfig.minColor;
            document.getElementById('maxColorPicker').value = colorConfig.maxColor;
            updateColorPreview();
            showWeightStatus('âœ… é¢œè‰²é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼', 'success');
        }

        // ç›‘å¬èˆªç­æ•°æ®æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const loadBtn = document.getElementById('loadFileBtn');
            const fileStatus = document.getElementById('fileStatus');
            
            if (this.files.length > 0) {
                loadBtn.disabled = false;
                fileStatus.textContent = '';
                fileStatus.className = '';
            } else {
                loadBtn.disabled = true;
            }
        });

        // åŠ è½½å¹¶è§£ææœ¬åœ°èˆªç­æ•°æ®æ–‡ä»¶
        function loadLocalFile() {
            const fileInput = document.getElementById('fileInput');
            const fileStatus = document.getElementById('fileStatus');
            const titleDisplay = document.getElementById('titleDisplay');
            const file = fileInput.files[0];

            if (!file) {
                fileStatus.textContent = 'âŒ é”™è¯¯ï¼šæœªé€‰æ‹©æ–‡ä»¶ï¼';
                fileStatus.className = 'error';
                return;
            }

            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedExtensions = ['.txt', '.json'];
            const fileExt = file.name.slice(file.name.lastIndexOf('.')).toLowerCase();
            if (!allowedExtensions.includes(fileExt)) {
                fileStatus.textContent = 'âŒ é”™è¯¯ï¼šä»…æ”¯æŒ .txt æˆ– .json æ ¼å¼æ–‡ä»¶ï¼';
                fileStatus.className = 'error';
                return;
            }

            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // è§£æJSONæ•°æ®ï¼ˆé€‚é…æ–°æ ¼å¼ï¼‰
                    const parsedData = JSON.parse(e.target.result);
                    
                    // æå–æ ‡é¢˜å’Œèˆªç­æ•°æ®ï¼ˆå…¼å®¹ä»»æ„æ ‡é¢˜é”®åï¼‰
                    const firstKey = Object.keys(parsedData)[0];
                    fileTitle = firstKey;
                    const flightData = parsedData[firstKey];

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!Array.isArray(flightData) || flightData.length === 0) {
                        throw new Error('èˆªç­æ•°æ®å¿…é¡»æ˜¯éç©ºæ•°ç»„ï¼');
                    }
                    
                    // éªŒè¯æ•°ç»„é¡¹æ ¼å¼
                    const requiredFields = ['date', 'time', 'origin'];
                    const firstItem = flightData[0];
                    const missingFields = requiredFields.filter(field => !firstItem.hasOwnProperty(field));
                    if (missingFields.length > 0) {
                        throw new Error(`æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå¤±å­—æ®µ ${missingFields.join(', ')}`);
                    }

                    // æ•°æ®åŠ è½½æˆåŠŸ
                    jsonData = flightData;
                    fileStatus.textContent = `âœ… æˆåŠŸåŠ è½½ ${jsonData.length} æ¡èˆªç­è®°å½•ï¼`;
                    fileStatus.className = 'success';
                    titleDisplay.textContent = `ğŸ“Œ æ•°æ®æ ‡é¢˜ï¼š${fileTitle}`;
                    
                    // æ˜¾ç¤ºç”Ÿæˆçƒ­åŠ›å›¾åŒºåŸŸ
                    document.getElementById('generateArea').style.display = 'block';
                    
                } catch (error) {
                    fileStatus.textContent = `âŒ æ–‡ä»¶è§£æé”™è¯¯ï¼š${error.message}`;
                    fileStatus.className = 'error';
                    jsonData = [];
                    fileTitle = "";
                    titleDisplay.textContent = "";
                }
            };

            reader.onerror = function() {
                fileStatus.textContent = 'âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåã€‚';
                fileStatus.className = 'error';
            };

            // ä»¥æ–‡æœ¬æ–¹å¼è¯»å–æ–‡ä»¶
            reader.readAsText(file, 'UTF-8');
        }

        // æå–å”¯ä¸€å‡ºå‘åœ°å¹¶æŒ‰å­—æ¯æ’åºæ˜¾ç¤ºæƒé‡è¾“å…¥æ¡†ï¼ˆé™åˆ¶æœ€å°å€¼0ï¼‰
        function extractOrigins() {
            if (jsonData.length === 0) {
                alert('âŒ æœªåŠ è½½èˆªç­æ•°æ®ï¼è¯·å…ˆåŠ è½½æœ‰æ•ˆæ–‡ä»¶ã€‚');
                return;
            }

            // 1. æå–æ‰€æœ‰å”¯ä¸€å‡ºå‘åœ°
            const originsSet = new Set(jsonData.map(item => item.origin));
            // 2. è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰å­—æ¯å‡åºæ’åºï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
            allOrigins = Array.from(originsSet).sort((a, b) => {
                return a.toLowerCase().localeCompare(b.toLowerCase());
            });

            const container = document.getElementById('weightInputsContainer');
            
            // æ¸…ç©ºåŸæœ‰è¾“å…¥æ¡†
            container.innerHTML = '';
            
            // æƒé‡è¯´æ˜ï¼ˆæ ‡æ³¨æ’åºæ–¹å¼å’Œå€¼èŒƒå›´ï¼‰
            const tip = document.createElement('div');
            tip.style.color = '#666';
            tip.style.marginBottom = '10px';
            tip.innerHTML = `<strong>ğŸ’¡ è¯´æ˜ï¼š</strong>æƒé‡è¶Šå¤§ï¼Œè¯¥å‡ºå‘åœ°èˆªç­å¯¹é¢œè‰²æ·±åº¦çš„è´¡çŒ®è¶Šé«˜ï¼ˆé»˜è®¤å€¼1ï¼‰ï¼Œå…± ${allOrigins.length} ä¸ªå‡ºå‘åœ°ï¼ˆæŒ‰å­—æ¯å‡åºæ’åˆ—ï¼‰<br>
            <strong>âš ï¸ è§„åˆ™ï¼š</strong>æƒé‡å€¼æœ€å°ä¸º0ï¼Œè¾“å…¥è´Ÿæ•°ä¼šè‡ªåŠ¨è½¬ä¸º0`;
            container.appendChild(tip);
            
            // 3. æŒ‰æ’åºåçš„é¡ºåºç”Ÿæˆæƒé‡è¾“å…¥æ¡†ï¼ˆé™åˆ¶æœ€å°å€¼0ï¼‰
            allOrigins.forEach(or => {
                const div = document.createElement('div');
                div.className = 'weight-input-group';
                const defaultValue = originWeights[or] || 1; // æœ‰ç¼“å­˜åˆ™ç”¨ç¼“å­˜å€¼ï¼Œå¦åˆ™é»˜è®¤1
                div.innerHTML = `${or}ï¼š<input type="number" id="weight_${or}" value="${defaultValue}" step="0.1" min="0" class="weight-input" oninput="validateWeightValue(this)">`;
                container.appendChild(div);
            });

            // å¯ç”¨ä¿å­˜æŒ‰é’®
            document.getElementById('saveWeightsBtn').disabled = false;
            document.getElementById('autoSaveBtn').disabled = false;
            document.getElementById('weightStatus').textContent = "âœ… å‡ºå‘åœ°æå–å®Œæˆï¼ˆæŒ‰å­—æ¯å‡åºæ’åˆ—ï¼‰ï¼Œæƒé‡å€¼æœ€å°ä¸º0ï¼Œå¯é…ç½®æƒé‡/é¢œè‰²å¹¶ä¿å­˜";
            document.getElementById('weightStatus').className = 'success';
        }

        // éªŒè¯æƒé‡å€¼ï¼ˆç¡®ä¿æœ€å°å€¼ä¸º0ï¼‰
        function validateWeightValue(input) {
            if (input.value === '') {
                input.value = 0;
            } else if (parseFloat(input.value) < 0) {
                input.value = 0;
                showWeightStatus('âš ï¸ æƒé‡å€¼ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œå·²è‡ªåŠ¨è½¬ä¸º0', 'info');
            }
        }

        // ä¿å­˜æƒé‡+é¢œè‰²é…ç½®åˆ°æœ¬åœ°JSONæ–‡ä»¶ï¼ˆæ–°å»ºæ–‡ä»¶ï¼Œä¸è¦†ç›–ï¼‰
        function saveWeightsToFile() {
            const weightInputs = document.querySelectorAll('[id^="weight_"]');
            if (weightInputs.length === 0) {
                showWeightStatus('âŒ é”™è¯¯ï¼šæš‚æ— æƒé‡é…ç½®å¯ä¿å­˜ï¼', 'error');
                return;
            }

            // æ”¶é›†å½“å‰æƒé‡é…ç½®ï¼ˆç¡®ä¿å€¼â‰¥0ï¼‰
            const weights = {};
            weightInputs.forEach(inp => {
                const origin = inp.id.slice(7);
                const value = parseFloat(inp.value) || 0;
                weights[origin] = Math.max(value, 0); // ç¡®ä¿å€¼â‰¥0
            });

            // ç»„åˆæƒé‡+é¢œè‰²é…ç½®
            const saveData = {
                version: "1.0",
                createTime: new Date().toLocaleString(),
                colorConfig: colorConfig,
                originWeights: weights
            };

            // æ›´æ–°å…¨å±€ç¼“å­˜
            originWeights = weights;

            // è½¬æ¢ä¸ºJSONå¹¶ä¸‹è½½
            const jsonStr = JSON.stringify(saveData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥ï¼ˆå¸¦æ—¥æœŸçš„æ–°æ–‡ä»¶åï¼‰
            const fileName = `èˆªç­æƒé‡é¢œè‰²é…ç½®_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            
            // è®°å½•æœ€åä¿å­˜çš„æ–‡ä»¶å
            lastWeightFile = fileName;
            
            // é‡Šæ”¾URLå¯¹è±¡
            URL.revokeObjectURL(url);
            
            // è¯¦ç»†çš„ä¿å­˜æˆåŠŸæç¤ºï¼ˆåŒ…å«ä½ç½®ä¿¡æ¯ï¼‰
            const tipMsg = `âœ… æƒé‡+é¢œè‰²é…ç½®å·²æˆåŠŸä¿å­˜ï¼
ğŸ“ æ–‡ä»¶åï¼š${fileName}
ğŸ¨ é¢œè‰²é…ç½®ï¼šæœ€å°å€¼${colorConfig.minColor} | æœ€å¤§å€¼${colorConfig.maxColor}
ğŸ“‚ ä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨é»˜è®¤ã€Œä¸‹è½½ã€æ–‡ä»¶å¤¹ï¼ˆå¯åœ¨æµè§ˆå™¨è®¾ç½®â†’ä¸‹è½½ä¸­æŸ¥çœ‹ï¼‰
ğŸ’¡ æç¤ºï¼šChrome/Firefoxé»˜è®¤è·¯å¾„é€šå¸¸ä¸ºã€Œæ­¤ç”µè„‘â†’ä¸‹è½½ã€ï¼ŒEdgeé»˜è®¤è·¯å¾„ä¸ºã€Œæ­¤ç”µè„‘â†’æ–‡æ¡£â†’ä¸‹è½½ã€`;
            showWeightStatus(tipMsg, 'success');
            
            // é¢å¤–å¼¹çª—æç¤ºï¼ˆå¯é€‰ï¼Œç¡®ä¿ç”¨æˆ·çœ‹åˆ°ï¼‰
            alert(`æƒé‡+é¢œè‰²é…ç½®æ–‡ä»¶ä¿å­˜æˆåŠŸï¼
æ–‡ä»¶åï¼š${fileName}
é¢œè‰²é…ç½®ï¼šæœ€å°å€¼${colorConfig.minColor} | æœ€å¤§å€¼${colorConfig.maxColor}
ä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹
ï¼ˆChrome/Firefoxï¼šæ­¤ç”µè„‘â†’ä¸‹è½½ï¼›Edgeï¼šæ­¤ç”µè„‘â†’æ–‡æ¡£â†’ä¸‹è½½ï¼‰`);
        }

        // è‡ªåŠ¨ä¿å­˜æƒé‡+é¢œè‰²ï¼ˆå¸¦è¦†ç›–ç¡®è®¤ï¼‰
        function autoSaveWeights() {
            const weightInputs = document.querySelectorAll('[id^="weight_"]');
            if (weightInputs.length === 0) {
                showWeightStatus('âŒ é”™è¯¯ï¼šæš‚æ— æƒé‡é…ç½®å¯ä¿å­˜ï¼', 'error');
                return;
            }

            // æ”¶é›†å½“å‰æƒé‡é…ç½®ï¼ˆç¡®ä¿å€¼â‰¥0ï¼‰
            const weights = {};
            weightInputs.forEach(inp => {
                const origin = inp.id.slice(7);
                const value = parseFloat(inp.value) || 0;
                weights[origin] = Math.max(value, 0); // ç¡®ä¿å€¼â‰¥0
            });

            // ç»„åˆæƒé‡+é¢œè‰²é…ç½®
            const saveData = {
                version: "1.0",
                createTime: new Date().toLocaleString(),
                colorConfig: colorConfig,
                originWeights: weights
            };

            // ç¡®è®¤é€»è¾‘
            let confirmMsg = '';
            if (lastWeightFile) {
                // æœ‰å†å²ä¿å­˜æ–‡ä»¶ï¼Œè¯¢é—®æ˜¯å¦è¦†ç›–ï¼ˆåŒ…å«ä½ç½®æç¤ºï¼‰
                confirmMsg = `âš ï¸ æ£€æµ‹åˆ°ä¸Šæ¬¡ä¿å­˜çš„é…ç½®æ–‡ä»¶ï¼š
${lastWeightFile}
ä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨é»˜è®¤ã€Œä¸‹è½½ã€æ–‡ä»¶å¤¹

å½“å‰é¢œè‰²é…ç½®ï¼šæœ€å°å€¼${colorConfig.minColor} | æœ€å¤§å€¼${colorConfig.maxColor}

æ˜¯å¦ç¡®è®¤è¦†ç›–è¯¥æ–‡ä»¶ï¼Ÿ
ï¼ˆå–æ¶ˆåˆ™å°†ä¿å­˜ä¸ºæ–°æ–‡ä»¶ï¼‰`;
            } else {
                // æ— å†å²æ–‡ä»¶ï¼Œç›´æ¥ç¡®è®¤ä¿å­˜ï¼ˆåŒ…å«ä½ç½®æç¤ºï¼‰
                confirmMsg = `ğŸ“„ æš‚æ— å†å²é…ç½®æ–‡ä»¶ï¼Œæ˜¯å¦ç¡®è®¤ä¿å­˜å½“å‰æƒé‡+é¢œè‰²é…ç½®ï¼Ÿ
ğŸ¨ é¢œè‰²é…ç½®ï¼šæœ€å°å€¼${colorConfig.minColor} | æœ€å¤§å€¼${colorConfig.maxColor}
ğŸ’¡ ä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨é»˜è®¤ã€Œä¸‹è½½ã€æ–‡ä»¶å¤¹`;
            }

            // å¼¹å‡ºç¡®è®¤æ¡†
            const isConfirm = confirm(confirmMsg);
            if (!isConfirm) {
                // ç”¨æˆ·å–æ¶ˆè¦†ç›–ï¼Œæ‰§è¡Œæ™®é€šä¿å­˜ï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰
                saveWeightsToFile();
                showWeightStatus('âœ… å·²å–æ¶ˆè¦†ç›–ï¼Œæƒé‡+é¢œè‰²é…ç½®å·²ä¿å­˜ä¸ºæ–°æ–‡ä»¶åˆ°ä¸‹è½½æ–‡ä»¶å¤¹', 'success');
                return;
            }

            // ç”¨æˆ·ç¡®è®¤è¦†ç›–/ä¿å­˜
            try {
                // æ›´æ–°å…¨å±€ç¼“å­˜
                originWeights = weights;

                // è½¬æ¢ä¸ºJSON
                const jsonStr = JSON.stringify(saveData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // ç¡®å®šæ–‡ä»¶åï¼ˆè¦†ç›–åˆ™ç”¨å†å²æ–‡ä»¶åï¼Œå¦åˆ™æ–°å»ºï¼‰
                const fileName = lastWeightFile || `èˆªç­æƒé‡é¢œè‰²é…ç½®_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                
                // æ›´æ–°æœ€åä¿å­˜çš„æ–‡ä»¶å
                lastWeightFile = fileName;
                
                // é‡Šæ”¾URLå¯¹è±¡
                URL.revokeObjectURL(url);
                
                // è¯¦ç»†çš„ä¿å­˜æˆåŠŸæç¤º
                let successMsg = '';
                if (lastWeightFile === fileName) {
                    successMsg = `âœ… å·²æˆåŠŸè¦†ç›–æƒé‡+é¢œè‰²é…ç½®æ–‡ä»¶ï¼
ğŸ“ æ–‡ä»¶åï¼š${fileName}
ğŸ¨ é¢œè‰²é…ç½®ï¼šæœ€å°å€¼${colorConfig.minColor} | æœ€å¤§å€¼${colorConfig.maxColor}
ğŸ“‚ ä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨é»˜è®¤ã€Œä¸‹è½½ã€æ–‡ä»¶å¤¹
ğŸ’¡ æç¤ºï¼šåŸæ–‡ä»¶å·²è¢«è¦†ç›–ï¼Œå¯åœ¨ä¸‹è½½æ–‡ä»¶å¤¹ä¸­æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬`;
                } else {
                    successMsg = `âœ… æƒé‡+é¢œè‰²é…ç½®å·²æˆåŠŸä¿å­˜ï¼
ğŸ“ æ–‡ä»¶åï¼š${fileName}
ğŸ¨ é¢œè‰²é…ç½®ï¼šæœ€å°å€¼${colorConfig.minColor} | æœ€å¤§å€¼${colorConfig.maxColor}
ğŸ“‚ ä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨é»˜è®¤ã€Œä¸‹è½½ã€æ–‡ä»¶å¤¹
ğŸ’¡ æç¤ºï¼šChrome/Firefoxé»˜è®¤è·¯å¾„é€šå¸¸ä¸ºã€Œæ­¤ç”µè„‘â†’ä¸‹è½½ã€ï¼ŒEdgeé»˜è®¤è·¯å¾„ä¸ºã€Œæ­¤ç”µè„‘â†’æ–‡æ¡£â†’ä¸‹è½½ã€`;
                }
                showWeightStatus(successMsg, 'success');
                
                // é¢å¤–å¼¹çª—æç¤º
                alert(`æƒé‡+é¢œè‰²é…ç½®æ–‡ä»¶${lastWeightFile === fileName ? 'è¦†ç›–' : 'ä¿å­˜'}æˆåŠŸï¼
æ–‡ä»¶åï¼š${fileName}
é¢œè‰²é…ç½®ï¼šæœ€å°å€¼${colorConfig.minColor} | æœ€å¤§å€¼${colorConfig.maxColor}
ä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹
ï¼ˆChrome/Firefoxï¼šæ­¤ç”µè„‘â†’ä¸‹è½½ï¼›Edgeï¼šæ­¤ç”µè„‘â†’æ–‡æ¡£â†’ä¸‹è½½ï¼‰`);
                
            } catch (error) {
                showWeightStatus(`âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        // ä»æœ¬åœ°æ–‡ä»¶åŠ è½½æƒé‡+é¢œè‰²é…ç½®ï¼ˆè‡ªåŠ¨åŒæ­¥æ‰€æœ‰å€¼ï¼‰
        function loadWeightsFromFile(input) {
            const file = input.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (file.name.slice(file.name.lastIndexOf('.')).toLowerCase() !== '.json') {
                showWeightStatus('âŒ é”™è¯¯ï¼šä»…æ”¯æŒJSONæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼', 'error');
                return;
            }

            // è®°å½•åŠ è½½çš„æ–‡ä»¶åï¼ˆç”¨äºåç»­è¦†ç›–ï¼‰
            lastWeightFile = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const saveData = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (typeof saveData !== 'object' || saveData === null) {
                        throw new Error('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯JSONå¯¹è±¡ï¼');
                    }

                    // 1. åŠ è½½é¢œè‰²é…ç½®ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
                    let loadedColorConfig = saveData.colorConfig || { minColor: "#F5F5F5", maxColor: "#1A237E" };
                    colorConfig = loadedColorConfig;
                    // æ›´æ–°é¢œè‰²é€‰æ‹©å™¨å’Œé¢„è§ˆ
                    document.getElementById('minColorPicker').value = colorConfig.minColor;
                    document.getElementById('maxColorPicker').value = colorConfig.maxColor;
                    updateColorPreview();

                    // 2. åŠ è½½æƒé‡é…ç½®ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
                    const loadedWeights = saveData.originWeights || saveData || {};
                    originWeights = loadedWeights;

                    // 3. è‡ªåŠ¨åŒæ­¥æ‰€æœ‰å‡ºå‘åœ°çš„æƒé‡å€¼åˆ°é¡µé¢è¾“å…¥æ¡†
                    let syncedCount = 0;
                    allOrigins.forEach(origin => {
                        const inputEl = document.getElementById(`weight_${origin}`);
                        if (inputEl) {
                            // å¦‚æœé…ç½®æ–‡ä»¶ä¸­æœ‰è¯¥å‡ºå‘åœ°çš„å€¼ï¼ˆåŒ…æ‹¬0ï¼‰ï¼Œåˆ™åŒæ­¥ï¼›å¦åˆ™ä¿æŒé»˜è®¤1
                            const weightValue = loadedWeights.hasOwnProperty(origin) ? Math.max(loadedWeights[origin], 0) : 1;
                            inputEl.value = weightValue;
                            syncedCount++;
                        }
                    });

                    // æç¤ºåŠ è½½ç»“æœ
                    showWeightStatus(`âœ… æˆåŠŸåŠ è½½æƒé‡+é¢œè‰²é…ç½®ï¼
ğŸ“ æ–‡ä»¶åï¼š${file.name}
ğŸ¨ åŠ è½½é¢œè‰²ï¼šæœ€å°å€¼${colorConfig.minColor} | æœ€å¤§å€¼${colorConfig.maxColor}
ğŸ”„ åŒæ­¥æƒé‡ï¼š${syncedCount}/${allOrigins.length} ä¸ªå‡ºå‘åœ°
ğŸ“ è¯´æ˜ï¼šå€¼ä¸º0çš„æƒé‡å·²åŒæ­¥ï¼Œæœªæ‰¾åˆ°çš„å‡ºå‘åœ°ä¿æŒé»˜è®¤å€¼1
ğŸ“‚ æ–‡ä»¶æ¥æºï¼š${file.path || 'æœ¬åœ°é€‰æ‹©çš„æ–‡ä»¶ï¼ˆé€šå¸¸ä¸ºä¸‹è½½æ–‡ä»¶å¤¹ï¼‰'}`, 'success');
                    
                    // å¼¹çª—æç¤ºåŠ è½½ç»“æœ
                    alert(`æƒé‡+é¢œè‰²é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸï¼
æ–‡ä»¶åï¼š${file.name}
é¢œè‰²é…ç½®ï¼šæœ€å°å€¼${colorConfig.minColor} | æœ€å¤§å€¼${colorConfig.maxColor}
åŒæ­¥æƒé‡ï¼š${syncedCount}/${allOrigins.length} ä¸ªå‡ºå‘åœ°
è¯´æ˜ï¼šå€¼ä¸º0çš„æƒé‡å·²åŒæ­¥ï¼Œæœªæ‰¾åˆ°çš„å‡ºå‘åœ°ä¿æŒé»˜è®¤å€¼1`);
                    
                } catch (error) {
                    showWeightStatus(`âŒ é…ç½®æ–‡ä»¶è§£æé”™è¯¯ï¼š${error.message}`, 'error');
                }
            };

            reader.onerror = function() {
                showWeightStatus('âŒ é…ç½®æ–‡ä»¶è¯»å–å¤±è´¥ï¼è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåã€‚', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        // æ˜¾ç¤ºæƒé‡æ“ä½œçŠ¶æ€æç¤ºï¼ˆæ”¯æŒæ¢è¡Œï¼‰
        function showWeightStatus(message, type) {
            const statusEl = document.getElementById('weightStatus');
            // æ›¿æ¢æ¢è¡Œç¬¦ä¸º<br>
            statusEl.innerHTML = message.replace(/\n/g, '<br>');
            statusEl.className = type;
            
            // 8ç§’åè‡ªåŠ¨æ¢å¤åŸºç¡€æç¤ºï¼ˆä¿ç•™ä½ç½®å’Œå€¼èŒƒå›´ä¿¡æ¯ï¼‰
            setTimeout(() => {
                if (document.getElementById('saveWeightsBtn').disabled) {
                    statusEl.innerHTML = "ğŸ’¡ æç¤ºï¼šè¯·å…ˆåŠ è½½èˆªç­æ•°æ®å¹¶æå–å‡ºå‘åœ°ï¼Œæƒé‡+é¢œè‰²é…ç½®æ–‡ä»¶å°†ä¿å­˜åˆ°æµè§ˆå™¨é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹ï¼Œæƒé‡å€¼æœ€å°ä¸º0";
                    statusEl.className = "info";
                } else {
                    statusEl.innerHTML = `âœ… å¯éšæ—¶ä¿®æ”¹æƒé‡/é¢œè‰²å¹¶ä¿å­˜ï¼ˆæƒé‡å€¼æœ€å°ä¸º0ï¼Œå½“å‰é¢œè‰²ï¼šæœ€å°å€¼${colorConfig.minColor} | æœ€å¤§å€¼${colorConfig.maxColor}ï¼‰`;
                    statusEl.className = 'success';
                }
            }, 8000); // å»¶é•¿æç¤ºæ—¶é—´åˆ°8ç§’ï¼Œç¡®ä¿ç”¨æˆ·çœ‹æ¸…
        }

        // ç”Ÿæˆçƒ­åŠ›å›¾ï¼ˆä½¿ç”¨è‡ªå®šä¹‰é¢œè‰²ï¼‰
        function generateHeatmap() {
            if (jsonData.length === 0) {
                alert('âŒ æœªåŠ è½½èˆªç­æ•°æ®ï¼è¯·å…ˆåŠ è½½æœ‰æ•ˆæ–‡ä»¶ã€‚');
                return;
            }

            // 1. æ”¶é›†æƒé‡é…ç½®ï¼ˆç¡®ä¿æ‰€æœ‰å€¼â‰¥0ï¼‰
            const weights = {};
            document.querySelectorAll('[id^="weight_"]').forEach(inp => {
                const origin = inp.id.slice(7);
                const value = parseFloat(inp.value) || 0;
                weights[origin] = Math.max(value, 0); // ç¡®ä¿å€¼â‰¥0
            });

            // 2. å¤„ç†æ•°æ®ï¼šæŒ‰æ—¥æœŸ-å°æ—¶åˆ†ç»„è®¡ç®—åŠ æƒå’Œ
            const dataMap = {};
            const dates = new Set();
            const hours = Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0'));

            // éå†æ‰€æœ‰èˆªç­æ•°æ®
            jsonData.forEach(item => {
                try {
                    const date = item.date;
                    // è§£æå°æ—¶ï¼ˆå…¼å®¹ä¸åŒæ—¶é—´æ ¼å¼ï¼‰
                    const timeParts = item.time.split(':');
                    const hour = timeParts[0].padStart(2, '0'); // ç¡®ä¿ä¸¤ä½æ•°å­—
                    const key = `${date}_${hour}`;
                    
                    dates.add(date);
                    dataMap[key] = (dataMap[key] || 0) + weights[item.origin];
                } catch (e) {
                    console.warn(`è·³è¿‡æ— æ•ˆæ•°æ®é¡¹ï¼š${JSON.stringify(item)}ï¼Œé”™è¯¯ï¼š${e.message}`);
                }
            });

            // 3. è·å–æœ€å¤§å€¼ç”¨äºé¢œè‰²æ˜ å°„
            const maxValue = Math.max(...Object.values(dataMap), 1); // é¿å…é™¤ä»¥0

            // 4. æ˜¾ç¤ºçƒ­åŠ›å›¾å®¹å™¨å¹¶ç”Ÿæˆè¡¨æ ¼
            document.getElementById('heatmapContainer').style.display = 'block';
            const table = document.getElementById('heatmapTable');
            table.innerHTML = '';

            // ç”Ÿæˆè¡¨å¤´ï¼ˆå°æ—¶ï¼‰
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>æ—¥æœŸ/æ˜ŸæœŸ</th>'; // ç¬¬ä¸€åˆ—æ ‡é¢˜
            hours.forEach(hour => {
                const th = document.createElement('th');
                th.textContent = `${hour}:00`;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // ç”Ÿæˆè¡¨ä½“ï¼ˆæ—¥æœŸÃ—å°æ—¶ï¼‰
            const tbody = document.createElement('tbody');
            const sortedDates = Array.from(dates).sort(); // æŒ‰æ—¥æœŸæ’åº

            sortedDates.forEach(date => {
                const row = document.createElement('tr');
                
                // æ—¥æœŸåˆ—ï¼ˆæ˜¾ç¤ºæ˜ŸæœŸå‡ ï¼Œä¸­æ–‡ï¼‰
                const dateCell = document.createElement('td');
                const dateObj = new Date(date);
                const weekdayMap = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                const weekday = weekdayMap[dateObj.getDay()];
                dateCell.textContent = `${date} (${weekday})`;
                dateCell.style.fontWeight = 'bold';
                dateCell.style.backgroundColor = '#f8f8f8';
                row.appendChild(dateCell);

                // æ¯å°æ—¶çš„æ•°æ®å•å…ƒæ ¼ï¼ˆä½¿ç”¨è‡ªå®šä¹‰é¢œè‰²ï¼‰
                hours.forEach(hour => {
                    const cell = document.createElement('td');
                    const value = dataMap[`${date}_${hour}`] || 0;
                    
                    if (value > 0) {
                        const color = getColor(value, maxValue);
                        cell.innerHTML = `<div class="heatmap-cell" style="background-color: ${color};" title="åŠ æƒå€¼ï¼š${value.toFixed(1)}"></div>`;
                    } else {
                        cell.innerHTML = `<div class="heatmap-cell no-data" style="background-color: ${colorConfig.minColor};" title="æ— èˆªç­æ•°æ®">--</div>`;
                    }
                    
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });

            table.appendChild(tbody);

            // 5. ç”Ÿæˆå›¾ä¾‹ï¼ˆä½¿ç”¨è‡ªå®šä¹‰é¢œè‰²ï¼‰
            generateLegend(maxValue);
        }

        // é¢œè‰²æ˜ å°„å‡½æ•°ï¼ˆä½¿ç”¨è‡ªå®šä¹‰çš„æœ€å°/æœ€å¤§é¢œè‰²ï¼‰
        function getColor(value, maxValue) {
            if (value <= 0) return colorConfig.minColor;
            
            const intensity = Math.min(value / maxValue, 1); // é™åˆ¶æœ€å¤§å¼ºåº¦ä¸º1
            
            // å°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºRGB
            const minRgb = hexToRgb(colorConfig.minColor);
            const maxRgb = hexToRgb(colorConfig.maxColor);
            
            // è®¡ç®—æ¸å˜é¢œè‰²
            const r = Math.round(minRgb.r + (maxRgb.r - minRgb.r) * intensity);
            const g = Math.round(minRgb.g + (maxRgb.g - minRgb.g) * intensity);
            const b = Math.round(minRgb.b + (maxRgb.b - minRgb.b) * intensity);
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        // åå…­è¿›åˆ¶é¢œè‰²è½¬RGBå¯¹è±¡
        function hexToRgb(hex) {
            // ç§»é™¤#å·
            hex = hex.replace(/^#/, '');
            
            // å¤„ç†3ä½å’Œ6ä½é¢œè‰²
            const r = parseInt(hex.length === 3 ? hex[0] + hex[0] : hex.substring(0, 2), 16);
            const g = parseInt(hex.length === 3 ? hex[1] + hex[1] : hex.substring(2, 4), 16);
            const b = parseInt(hex.length === 3 ? hex[2] + hex[2] : hex.substring(4, 6), 16);
            
            return { r, g, b };
        }

        // ç”Ÿæˆå›¾ä¾‹ï¼ˆä½¿ç”¨è‡ªå®šä¹‰é¢œè‰²ï¼‰
        function generateLegend(maxValue) {
            const legend = document.getElementById('legend');
            legend.innerHTML = `<strong>ğŸ“ å›¾ä¾‹ï¼ˆåŠ æƒå€¼ï¼‰ï¼š</strong>ï¼ˆé¢œè‰²èŒƒå›´ï¼š${colorConfig.minColor} â†’ ${colorConfig.maxColor}ï¼‰`;
            
            const steps = 5;
            for (let i = 0; i <= steps; i++) {
                const ratio = i / steps;
                const value = (maxValue * ratio).toFixed(1);
                const color = getColor(maxValue * ratio, maxValue);
                
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${color};"></div>
                    <span>${value}${i === steps ? ' (æœ€å¤§å€¼)' : ''}</span>
                `;
                legend.appendChild(item);
            }
        }
    </script>
</body>
</html>